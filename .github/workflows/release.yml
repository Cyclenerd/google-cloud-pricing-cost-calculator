name: Release

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  linux:
    name: Linux
    # Ubuntu          Debian
    # 20.04  focal    bullseye/ sid - 11 (Google Cloud Shell)
    #
    # No support for Debian 10, Ubuntu 18.04 and older:
    #   pp on Ubuntu 20.04 and run on Debian 10
    #   /tmp/par-6e696c73/cache[...]/gcosts: /lib/x86_64-linux-gnu/libm.so.6: version `GLIBC_2.29' not found (required by /tmp/par-6e696c73/cache-[...]/libperl.so.5.30)
    runs-on: ubuntu-20.04
    steps:
      - name: ğŸ”§ Install dependencies
        run: |
          sudo apt-get install   \
            libapp-options-perl  \
            libyaml-libyaml-perl \
            libpar-packer-perl
      - name: ğŸ›ï¸ Checkout
        uses: actions/checkout@v3
      # Test source
      - name: ğŸŒ¡ï¸ Test gcosts.pl
        run: perl gcosts.pl --version 
      # Pack 'gcosts.pl' into executable 'gcosts'
      - name: â³ Compile
        run: pp -vvv -l libyaml-0.so.2 -o gcosts gcosts.pl
      # Test binary
      - name: ğŸŒ¡ï¸ Test binary
        run: ./gcosts --version
      - name: ğŸŒ¡ï¸ Calculate
        run: cd t && ../gcosts -pricing="../pricing.yml"
      - name: ğŸŒ¡ï¸ Test
        run: cd t && bash test.sh && rm *.csv
      # Upload binary
      # https://github.com/actions/download-artifact
      - name: ğŸ“¤ Upload gcosts
        uses: actions/upload-artifact@v3
        with:
          name: gcosts
          path: gcosts
          retention-days: 1

  test-linux:
    name: Test Linux
    needs: linux
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›ï¸ Checkout
        uses: actions/checkout@v3
      - name: ğŸ“¥ Download gcosts
        uses: actions/download-artifact@v3
        with:
          name: gcosts
      # Test binary
      - name: ğŸŒ¡ï¸ Test gcosts
        run: chmod +x gcosts && ./gcosts --version
      - name: ğŸŒ¡ï¸ Calculate
        run: cd t && ../gcosts -pricing="../pricing.yml"
      - name: ğŸŒ¡ï¸ Test
        run: cd t && bash test.sh && rm *.csv

  windows:
    name: Windows
    runs-on: windows-latest
    steps:
      - name: ğŸ›ï¸ Checkout
        uses: actions/checkout@v3
      # Strawberry for Windows
      # https://strawberryperl.com/
      # https://github.com/shogo82148/actions-setup-perl
      - uses: shogo82148/actions-setup-perl@v1
        with:
          perl-version: '5.32'
          distribution: strawberry
      # Install requirements
      - name: ğŸ”§ Install requirements
        run: cpanm --installdeps .
      - name: ğŸ”§ Install pp
        run: cpanm --verbose --no-interactive --force PAR::Packer
      # Test source
      - name: ğŸŒ¡ï¸ Test gcosts.pl
        run: perl gcosts.pl --version
      # Pack 'gcosts.pl' into executable 'gcosts'
      - name: â³ Compile
        run: pp -vvv -o gcosts.exe gcosts.pl
      # Test binary
      - name: ğŸŒ¡ï¸ Test binary
        run: .\gcosts.exe --version
      - name: ğŸŒ¡ï¸ Calculate
        run: cd t && ..\gcosts.exe -pricing="..\pricing.yml"
      - name: ğŸŒ¡ï¸ Test n2-standard-8 in euw4
        run: Select-String -Path .\t\COSTS.csv -pattern "europe-west4;vm;n2-standard-8;249"
      # Upload binary
      - name: ğŸ“¤ Upload gcosts.exe
        uses: actions/upload-artifact@v3
        with:
          name: gcosts.exe
          path: gcosts.exe
          retention-days: 1

  test-windows:
    name: Test Windows
    needs: windows
    runs-on: windows-latest
    steps:
      - name: ğŸ›ï¸ Checkout
        uses: actions/checkout@v3
      - name: ğŸ“¥ Download gcosts.exe
        uses: actions/download-artifact@v3
        with:
          name: gcosts.exe
      # Test binary
      - name: ğŸŒ¡ï¸ Test binary
        run: .\gcosts.exe --version
      - name: ğŸŒ¡ï¸ Calculate
        run: cd t && ..\gcosts.exe -pricing="..\pricing.yml"
      - name: ğŸŒ¡ï¸ Test n2-standard-8 in euw4
        run: Select-String -Path .\t\COSTS.csv -pattern "europe-west4;vm;n2-standard-8;249"

  release:
    name: Release
    needs: [test-linux, test-windows]
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›ï¸ Checkout
        uses: actions/checkout@v3
      # Download all artifacts to the current working directory
      - name: ğŸ“¥ Download
        uses: actions/download-artifact@v3
      # Release, upload files
      # https://github.com/softprops/action-gh-release
      - name: âœ¨ Release
        uses: softprops/action-gh-release@v1.1.14
        with:
          files: |
            gcosts
            gcosts.exe
            gcosts.pl
            pricing.yml