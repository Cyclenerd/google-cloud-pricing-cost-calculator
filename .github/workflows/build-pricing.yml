name: "Build Pricing"

on:
  workflow_dispatch:
  schedule:
    - cron: '45 3 * * 4' # At 03:45 on Thursday

jobs:
  build-pricing:
    name: Build pricing information file
    runs-on: ubuntu-latest
    steps:
      - name: 🔧 Install dependencies
        run: |
          sudo apt-get install   \
            libapp-options-perl  \
            libwww-perl          \
            libjson-xs-perl      \
            libyaml-libyaml-perl \
            libdbd-csv-perl      \
            libdbd-sqlite3-perl

      - name: 🛎️ Checkout
        uses: actions/checkout@v2

      # gcosts Version
      - name: 💡 Version
        run: perl gcosts.pl --version

      # Export SKUs
      - name: 📥 Export SKUs
        env:
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          cd build || exit 9
          perl skus.pl -csv="skus_compute.csv"     -id="6F81-5844-456A" && \
          perl skus.pl -csv="skus_storage.csv"     -id="95FF-2EF5-5EA1" && \
          perl skus.pl -csv="skus_stackdriver.csv" -id="58CD-E7C3-72CA" && \
          perl skus.pl -csv="skus_sql.csv"         -id="9662-B51E-5089"

      # Merge SKU files
      - name: 📚 Merge SKUs to skus.csv
        run: |
          cd build || exit 9
          cat "skus_compute.csv"      > "skus.csv" && \
          cat "skus_storage.csv"     >> "skus.csv" && \
          cat "skus_stackdriver.csv" >> "skus.csv" && \
          cat "skus_sql.csv"         >> "skus.csv"

      # Add custom mapping IDs to SKUs
      - name: 🔦 Add Mapping
        run: cd build && perl mapping.pl

      # Generate pricing informations
      - name: ⏳ Generate Pricing
        run: cd build && perl pricing.pl -details=0

      # Test pricing
      - name: 🌡️ Test
        run: |
          cd t && \
          bash gcosts.sh && \
          bash test.sh
      
      # Release new pricing.yml
      - name: 🤝 Release
        run: cd build && mv pricing.yml ../pricing.yml
      # Push
      - name: ✨ Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add pricing.yml && \
          git commit -m "Pricing updated" && \
          git push