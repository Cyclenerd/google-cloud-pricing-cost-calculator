name: "Build Pricing"

on:
  workflow_dispatch:

jobs:
  build-pricing:
    name: Build pricing information file
    runs-on: ubuntu-latest
    steps:
      - name: 🔧 Install dependencies
        run: |
          sudo apt-get install  \
            libapp-options-perl \
            libwww-perl         \
            libjson-xs-perl     \
            libdbd-csv-perl

      - name: 🛎️ Checkout
        uses: actions/checkout@v2

      # Export SKUs
      - name: 📥 Export SKUs
        env:
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          cd build || exit 9
          perl skus.pl -csv="/tmp/skus_compute.csv"     -id="6F81-5844-456A" && \
          perl skus.pl -csv="/tmp/skus_storage.csv"     -id="95FF-2EF5-5EA1" && \
          perl skus.pl -csv="/tmp/skus_stackdriver.csv" -id="58CD-E7C3-72CA" && \
          perl skus.pl -csv="/tmp/skus_sql.csv"         -id="9662-B51E-5089"

      # Merge SKU files
      - name: 📚 Merge SKUs to skus.csv
        run: |
          cat "/tmp/skus_compute.csv"      > "/tmp/skus.csv" && \
          cat "/tmp/skus_storage.csv"     >> "/tmp/skus.csv" && \
          cat "/tmp/skus_stackdriver.csv" >> "/tmp/skus.csv" && \
          cat "/tmp/skus_sql.csv"         >> "/tmp/skus.csv"

      # Add custom mapping IDs to SKUs
      - name: 🔦 Custom Mapping
        run: perl ./build/mapping.pl -sku="/tmp/skus.csv" -mapping=./build/mapping.csv